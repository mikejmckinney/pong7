# CI/CD Pipeline for Pong Game
# 
# This workflow runs on every push to validate code quality and functionality.
# It follows the test pyramid: many unit tests, fewer integration tests, minimal E2E tests.
#
# Phase Detection:
# - Planning Phase: Only documentation exists, skips code tests
# - Implementation Phase: Full test suite runs
#
# Self-Healing Protocol:
# If tests fail, the error logs are captured as artifacts.
# AI agents should read these logs, fix the issues, and retry until all tests pass.

name: CI Tests

on:
  push:
    branches: [main, master, develop, 'feature/**', 'cursor/**']
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # DETECT PROJECT PHASE
  # ============================================
  detect-phase:
    name: Detect Project Phase
    runs-on: ubuntu-latest
    outputs:
      has_frontend: ${{ steps.check.outputs.has_frontend }}
      has_backend: ${{ steps.check.outputs.has_backend }}
      has_tests: ${{ steps.check.outputs.has_tests }}
      phase: ${{ steps.check.outputs.phase }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check project state
        id: check
        run: |
          echo "Detecting project phase..."
          
          # Check for frontend implementation
          if [ -f "package.json" ] && [ -f "index.html" ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
            echo "‚úì Frontend implementation detected"
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
            echo "‚óã No frontend implementation yet"
          fi
          
          # Check for backend implementation
          if [ -f "server/package.json" ] && [ -f "server/index.js" ]; then
            echo "has_backend=true" >> $GITHUB_OUTPUT
            echo "‚úì Backend implementation detected"
          else
            echo "has_backend=false" >> $GITHUB_OUTPUT
            echo "‚óã No backend implementation yet"
          fi
          
          # Check for test files
          if [ -d "tests" ] || [ -d "server/tests" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "‚úì Test files detected"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "‚óã No test files yet"
          fi
          
          # Determine overall phase
          if [ -f "package.json" ] || [ -f "server/package.json" ]; then
            echo "phase=implementation" >> $GITHUB_OUTPUT
            echo ""
            echo "üì¶ Phase: IMPLEMENTATION"
            echo "   Running full test suite..."
          else
            echo "phase=planning" >> $GITHUB_OUTPUT
            echo ""
            echo "üìã Phase: PLANNING"
            echo "   Skipping code tests (no implementation yet)"
            echo "   Running documentation/structure checks only"
          fi

  # ============================================
  # VERIFY REPOSITORY STRUCTURE (Always runs)
  # ============================================
  verify-structure:
    name: Verify Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run repository verification
        run: |
          if [ -f "./test.sh" ]; then
            chmod +x ./test.sh
            ./test.sh 2>&1 | tee structure-check.log
          else
            echo "test.sh not found"
            exit 1
          fi

      - name: Upload structure check logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: structure-check-logs
          path: structure-check.log
          retention-days: 7

  # ============================================
  # LINT - Check code style and syntax
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: [detect-phase]
    if: needs.detect-phase.outputs.phase == 'implementation'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm ci

      - name: Install backend dependencies
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: npm ci
        working-directory: server

      - name: Lint frontend
        id: lint-frontend
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm run lint 2>&1 | tee lint-frontend.log
        continue-on-error: true

      - name: Lint backend
        id: lint-backend
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: npm run lint 2>&1 | tee lint-backend.log
        working-directory: server
        continue-on-error: true

      - name: Upload lint logs on failure
        if: failure() || steps.lint-frontend.outcome == 'failure' || steps.lint-backend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: |
            lint-frontend.log
            server/lint-backend.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Check lint results
        run: |
          FAILED=false
          if [ "${{ steps.lint-frontend.outcome }}" = "failure" ]; then
            echo "::error::Frontend lint failed"
            FAILED=true
          fi
          if [ "${{ steps.lint-backend.outcome }}" = "failure" ]; then
            echo "::error::Backend lint failed"
            FAILED=true
          fi
          if [ "$FAILED" = "true" ]; then
            exit 1
          fi
          echo "‚úÖ Lint passed"

  # ============================================
  # UNIT TESTS - Fast, isolated function tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-phase]
    if: needs.detect-phase.outputs.phase == 'implementation' && needs.detect-phase.outputs.has_tests == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm ci

      - name: Install backend dependencies
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: npm ci
        working-directory: server

      - name: Run frontend unit tests
        id: test-frontend
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: |
          npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary 2>&1 | tee test-frontend.log
        continue-on-error: true

      - name: Run backend unit tests
        id: test-backend
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: |
          npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary 2>&1 | tee test-backend.log
        working-directory: server
        continue-on-error: true

      - name: Upload test logs on failure
        if: failure() || steps.test-frontend.outcome == 'failure' || steps.test-backend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs
          path: |
            test-frontend.log
            server/test-backend.log
            coverage/
            server/coverage/
          retention-days: 7
          if-no-files-found: ignore

      - name: Check test results
        run: |
          FAILED=false
          if [ "${{ steps.test-frontend.outcome }}" = "failure" ]; then
            echo "::error::Frontend unit tests failed"
            FAILED=true
          fi
          if [ "${{ steps.test-backend.outcome }}" = "failure" ]; then
            echo "::error::Backend unit tests failed"
            FAILED=true
          fi
          if [ "$FAILED" = "true" ]; then
            exit 1
          fi
          echo "‚úÖ Unit tests passed"

  # ============================================
  # INTEGRATION TESTS - Component interaction tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-phase, lint, unit-tests]
    if: |
      always() &&
      needs.detect-phase.outputs.phase == 'implementation' &&
      needs.detect-phase.outputs.has_tests == 'true' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm ci

      - name: Install backend dependencies
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: npm ci
        working-directory: server

      - name: Run frontend integration tests
        id: integration-frontend
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: |
          npm test -- --testPathPattern="integration" 2>&1 | tee integration-frontend.log
        continue-on-error: true

      - name: Run backend integration tests
        id: integration-backend
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: |
          npm test -- --testPathPattern="integration" 2>&1 | tee integration-backend.log
        working-directory: server
        continue-on-error: true

      - name: Upload integration test logs on failure
        if: failure() || steps.integration-frontend.outcome == 'failure' || steps.integration-backend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            integration-frontend.log
            server/integration-backend.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Check integration test results
        run: |
          FAILED=false
          if [ "${{ steps.integration-frontend.outcome }}" = "failure" ]; then
            echo "::error::Frontend integration tests failed"
            FAILED=true
          fi
          if [ "${{ steps.integration-backend.outcome }}" = "failure" ]; then
            echo "::error::Backend integration tests failed"
            FAILED=true
          fi
          if [ "$FAILED" = "true" ]; then
            exit 1
          fi
          echo "‚úÖ Integration tests passed"

  # ============================================
  # BUILD - Validate project builds successfully
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [detect-phase, lint]
    if: |
      always() &&
      needs.detect-phase.outputs.phase == 'implementation' &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm ci

      - name: Install backend dependencies
        if: needs.detect-phase.outputs.has_backend == 'true'
        run: npm ci
        working-directory: server

      - name: Validate HTML/JS files
        run: |
          echo "Validating project structure..."
          ERRORS=0
          
          # Check for essential frontend files
          if [ -f "index.html" ]; then
            echo "‚úì index.html exists"
          fi
          
          # Check for server entry point and validate syntax
          if [ -f "server/index.js" ]; then
            echo "‚úì server/index.js exists"
            if node --check server/index.js 2>&1; then
              echo "‚úì server/index.js syntax valid"
            else
              echo "‚úó server/index.js has syntax errors"
              ERRORS=$((ERRORS + 1))
            fi
          fi
          
          # Validate JavaScript syntax for all JS files
          if [ -d "js" ]; then
            echo "Checking JS files..."
            for file in js/*.js; do
              if [ -f "$file" ]; then
                if node --check "$file" 2>&1; then
                  echo "‚úì $file syntax valid"
                else
                  echo "‚úó $file has syntax errors"
                  ERRORS=$((ERRORS + 1))
                fi
              fi
            done
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo "::error::Found $ERRORS syntax errors"
            exit 1
          fi

      - name: Build frontend (if build script exists)
        if: needs.detect-phase.outputs.has_frontend == 'true'
        run: npm run build --if-present 2>&1 | tee build.log || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
            build.log
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # E2E TESTS - End-to-end user journey tests
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [detect-phase, build, integration-tests]
    if: |
      always() &&
      needs.detect-phase.outputs.phase == 'implementation' &&
      needs.detect-phase.outputs.has_frontend == 'true' &&
      needs.detect-phase.outputs.has_tests == 'true' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (needs.integration-tests.result == 'success' || needs.integration-tests.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start server for E2E tests
        id: server
        run: |
          npx serve -s . -p 8080 &
          SERVER_PID=$!
          echo "server_pid=$SERVER_PID" >> $GITHUB_OUTPUT
          
          # Wait for server to be ready (max 30 seconds)
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "‚úÖ Server started successfully on port 8080"
              exit 0
            fi
            sleep 1
          done
          
          echo "::error::Server failed to start within 30 seconds"
          exit 1

      - name: Check for E2E test directory
        id: check-e2e
        run: |
          if [ -d "tests/e2e" ]; then
            echo "has_e2e_tests=true" >> $GITHUB_OUTPUT
            echo "‚úì E2E test directory found"
          else
            echo "has_e2e_tests=false" >> $GITHUB_OUTPUT
            echo "‚óã No tests/e2e directory - E2E tests will be skipped"
          fi

      - name: Run E2E tests
        id: e2e
        if: steps.check-e2e.outputs.has_e2e_tests == 'true'
        run: npx playwright test 2>&1 | tee e2e-test.log
        continue-on-error: true

      - name: Upload E2E test results
        if: failure() || steps.e2e.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            e2e-test.log
            playwright-report/
            test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Check E2E test results
        run: |
          if [ "${{ steps.check-e2e.outputs.has_e2e_tests }}" = "false" ]; then
            echo "‚è≠Ô∏è E2E tests skipped (no tests/e2e directory)"
            exit 0
          fi
          
          if [ "${{ steps.e2e.outcome }}" = "failure" ]; then
            echo "::error::E2E tests failed. Check the e2e-test-results artifact for details."
            exit 1
          fi
          echo "‚úÖ E2E tests passed"

  # ============================================
  # SUMMARY - Final status check
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [detect-phase, verify-structure, lint, unit-tests, integration-tests, build, e2e-tests]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "============================================"
          echo "CI Pipeline Summary"
          echo "============================================"
          echo ""
          echo "Project Phase: ${{ needs.detect-phase.outputs.phase }}"
          echo ""
          echo "Job Results:"
          echo "  Detect Phase:        ${{ needs.detect-phase.result }}"
          echo "  Verify Structure:    ${{ needs.verify-structure.result }}"
          echo "  Lint:                ${{ needs.lint.result }}"
          echo "  Unit Tests:          ${{ needs.unit-tests.result }}"
          echo "  Integration Tests:   ${{ needs.integration-tests.result }}"
          echo "  Build:               ${{ needs.build.result }}"
          echo "  E2E Tests:           ${{ needs.e2e-tests.result }}"
          echo ""
          
          # Check if detect-phase failed first
          if [ "${{ needs.detect-phase.result }}" = "failure" ]; then
            echo "============================================"
            echo "‚ùå Phase detection failed"
            echo "============================================"
            echo "::error::detect-phase job failed - cannot determine project state"
            exit 1
          fi
          
          # In planning phase, only structure verification matters
          if [ "${{ needs.detect-phase.outputs.phase }}" = "planning" ]; then
            if [ "${{ needs.verify-structure.result }}" = "success" ]; then
              echo "============================================"
              echo "‚úÖ Planning Phase - All checks passed!"
              echo "============================================"
              echo ""
              echo "Documentation and structure verified."
              echo "Code tests will run once implementation begins."
              exit 0
            else
              echo "============================================"
              echo "‚ùå Planning Phase - Structure check failed"
              echo "============================================"
              exit 1
            fi
          fi
          
          # In implementation phase, check all jobs
          FAILED=false
          
          if [ "${{ needs.verify-structure.result }}" = "failure" ]; then
            echo "::error::Repository structure verification failed"
            FAILED=true
          fi
          
          if [ "${{ needs.lint.result }}" = "failure" ]; then
            echo "::error::Lint check failed"
            FAILED=true
          fi
          
          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
            echo "::error::Unit tests failed"
            FAILED=true
          fi
          
          if [ "${{ needs.integration-tests.result }}" = "failure" ]; then
            echo "::error::Integration tests failed"
            FAILED=true
          fi
          
          if [ "${{ needs.build.result }}" = "failure" ]; then
            echo "::error::Build failed"
            FAILED=true
          fi
          
          if [ "${{ needs.e2e-tests.result }}" = "failure" ]; then
            echo "::error::E2E tests failed"
            FAILED=true
          fi
          
          if [ "$FAILED" = "true" ]; then
            echo "============================================"
            echo "‚ùå CI FAILED - Self-Healing Required"
            echo "============================================"
            echo ""
            echo "AI Agent Instructions:"
            echo "1. Download the failed job's artifact"
            echo "2. Read the error logs carefully"
            echo "3. Fix the underlying issue in the code"
            echo "4. Commit and push the fix"
            echo "5. Verify the CI passes"
            echo ""
            echo "See: .github/agents/self-healing.agent.md"
            exit 1
          fi
          
          echo "============================================"
          echo "‚úÖ All CI checks passed!"
          echo "============================================"
