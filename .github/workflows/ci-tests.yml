# CI/CD Pipeline for Pong Game
# 
# This workflow runs on every push to validate code quality and functionality.
# It follows the test pyramid: many unit tests, fewer integration tests, minimal E2E tests.
#
# Self-Healing Protocol:
# If tests fail, the error logs are captured as artifacts.
# AI agents should read these logs, fix the issues, and retry until all tests pass.

name: CI Tests

on:
  push:
    branches: [main, master, develop, 'feature/**', 'cursor/**']
  pull_request:
    branches: [main, master, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # LINT - Check code style and syntax
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        continue-on-error: true

      - name: Install backend dependencies
        run: npm ci
        working-directory: server
        continue-on-error: true

      - name: Lint frontend
        id: lint-frontend
        run: npm run lint 2>&1 | tee lint-frontend.log || true
        continue-on-error: true

      - name: Lint backend
        id: lint-backend
        run: npm run lint 2>&1 | tee lint-backend.log || true
        working-directory: server
        continue-on-error: true

      - name: Upload lint logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: |
            lint-frontend.log
            server/lint-backend.log
          retention-days: 7

  # ============================================
  # UNIT TESTS - Fast, isolated function tests
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        continue-on-error: true

      - name: Install backend dependencies
        run: npm ci
        working-directory: server
        continue-on-error: true

      - name: Run frontend unit tests
        id: test-frontend
        run: |
          npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary 2>&1 | tee test-frontend.log
        continue-on-error: true

      - name: Run backend unit tests
        id: test-backend
        run: |
          npm test -- --coverage --coverageReporters=text --coverageReporters=json-summary 2>&1 | tee test-backend.log
        working-directory: server
        continue-on-error: true

      - name: Upload test logs on failure
        if: failure() || steps.test-frontend.outcome == 'failure' || steps.test-backend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs
          path: |
            test-frontend.log
            server/test-backend.log
            coverage/
            server/coverage/
          retention-days: 7

      - name: Check test results
        run: |
          if [ "${{ steps.test-frontend.outcome }}" = "failure" ] || [ "${{ steps.test-backend.outcome }}" = "failure" ]; then
            echo "::error::Unit tests failed. Check the test-logs artifact for details."
            exit 1
          fi

  # ============================================
  # INTEGRATION TESTS - Component interaction tests
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        continue-on-error: true

      - name: Install backend dependencies
        run: npm ci
        working-directory: server
        continue-on-error: true

      - name: Run frontend integration tests
        id: integration-frontend
        run: |
          npm test -- --testPathPattern="integration" 2>&1 | tee integration-frontend.log
        continue-on-error: true

      - name: Run backend integration tests
        id: integration-backend
        run: |
          npm test -- --testPathPattern="integration" 2>&1 | tee integration-backend.log
        working-directory: server
        continue-on-error: true

      - name: Upload integration test logs on failure
        if: failure() || steps.integration-frontend.outcome == 'failure' || steps.integration-backend.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: |
            integration-frontend.log
            server/integration-backend.log
          retention-days: 7

      - name: Check integration test results
        run: |
          if [ "${{ steps.integration-frontend.outcome }}" = "failure" ] || [ "${{ steps.integration-backend.outcome }}" = "failure" ]; then
            echo "::error::Integration tests failed. Check the integration-test-logs artifact for details."
            exit 1
          fi

  # ============================================
  # BUILD - Validate project builds successfully
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            server/package-lock.json

      - name: Install frontend dependencies
        run: npm ci
        continue-on-error: true

      - name: Install backend dependencies
        run: npm ci
        working-directory: server
        continue-on-error: true

      - name: Validate HTML/JS files exist
        run: |
          echo "Validating project structure..."
          
          # Check for essential frontend files (when implemented)
          if [ -f "index.html" ]; then
            echo "✓ index.html exists"
          else
            echo "⚠ index.html not found (expected during implementation)"
          fi
          
          # Check for server entry point
          if [ -f "server/index.js" ]; then
            echo "✓ server/index.js exists"
            # Validate syntax
            node --check server/index.js && echo "✓ server/index.js syntax valid" || echo "✗ server/index.js has syntax errors"
          else
            echo "⚠ server/index.js not found (expected during implementation)"
          fi
          
          # Validate JavaScript syntax for all JS files
          if [ -d "js" ]; then
            echo "Checking JS files..."
            for file in js/*.js; do
              if [ -f "$file" ]; then
                node --check "$file" 2>&1 && echo "✓ $file syntax valid" || echo "✗ $file has syntax errors"
              fi
            done
          fi

      - name: Build frontend (if build script exists)
        run: |
          if npm run build --if-present 2>&1 | tee build.log; then
            echo "Build completed successfully"
          else
            echo "No build script or build failed"
          fi
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            dist/
            build/
            build.log
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # E2E TESTS - End-to-end user journey tests
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci
        continue-on-error: true

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        continue-on-error: true

      - name: Start server for E2E tests
        run: |
          if [ -f "index.html" ]; then
            npx serve -s . -p 8080 &
            sleep 3
            echo "Server started on port 8080"
          else
            echo "No index.html - skipping E2E tests (expected during planning phase)"
            exit 0
          fi
        continue-on-error: true

      - name: Run E2E tests
        id: e2e
        run: |
          if [ -f "index.html" ] && [ -d "tests/e2e" ]; then
            npx playwright test 2>&1 | tee e2e-test.log
          else
            echo "E2E tests not configured yet - skipping"
            exit 0
          fi
        continue-on-error: true

      - name: Upload E2E test results
        if: failure() || steps.e2e.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            e2e-test.log
            playwright-report/
            test-results/
          retention-days: 7

      - name: Check E2E test results
        run: |
          if [ "${{ steps.e2e.outcome }}" = "failure" ]; then
            echo "::error::E2E tests failed. Check the e2e-test-results artifact for details."
            exit 1
          fi

  # ============================================
  # SUMMARY - Final status check
  # ============================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, build, e2e-tests]
    if: always()
    steps:
      - name: Check all job results
        run: |
          echo "============================================"
          echo "CI Pipeline Summary"
          echo "============================================"
          echo ""
          echo "Lint:              ${{ needs.lint.result }}"
          echo "Unit Tests:        ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Build:             ${{ needs.build.result }}"
          echo "E2E Tests:         ${{ needs.e2e-tests.result }}"
          echo ""
          
          # Check if any job failed
          if [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.build.result }}" == "failure" ]] || \
             [[ "${{ needs.e2e-tests.result }}" == "failure" ]]; then
            echo "============================================"
            echo "❌ CI FAILED - Self-Healing Required"
            echo "============================================"
            echo ""
            echo "AI Agent Instructions:"
            echo "1. Download the failed job's artifact"
            echo "2. Read the error logs carefully"
            echo "3. Fix the underlying issue in the code"
            echo "4. Commit and push the fix"
            echo "5. Verify the CI passes"
            echo ""
            echo "See: .github/agents/self-healing.agent.md"
            exit 1
          else
            echo "============================================"
            echo "✅ All CI checks passed!"
            echo "============================================"
          fi

  # ============================================
  # VERIFY REPOSITORY STRUCTURE
  # ============================================
  verify-structure:
    name: Verify Repository Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run repository verification
        run: |
          if [ -f "./test.sh" ]; then
            chmod +x ./test.sh
            ./test.sh 2>&1 | tee structure-check.log
          else
            echo "test.sh not found"
            exit 1
          fi

      - name: Upload structure check logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: structure-check-logs
          path: structure-check.log
          retention-days: 7
