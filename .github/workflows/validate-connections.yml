# Connection Validation Workflow
#
# Tests connectivity to backend server and Supabase database.
# Runs daily and can be triggered manually.
#
# This ensures the production infrastructure is working correctly.

name: Validate Connections

on:
  schedule:
    # Run daily at 8 AM UTC
    - cron: '0 8 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on PRs that modify connection-related files
  pull_request:
    paths:
      - 'js/config.js'
      - 'scripts/validate-connections.js'
      - 'server/index.js'

env:
  NODE_VERSION: '20'
  BACKEND_URL: 'https://pong7.onrender.com'
  SUPABASE_URL: 'https://sjeyisealyvavzjrdcgf.supabase.co'

jobs:
  validate-backend:
    name: Validate Backend Server
    runs-on: ubuntu-latest
    steps:
      - name: Test backend health endpoint
        id: health
        run: |
          echo "üîç Testing backend health endpoint..."
          echo "URL: ${{ env.BACKEND_URL }}"
          
          # First request may be slow due to cold start
          echo "Making request (may take up to 60s for cold start)..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --max-time 120 \
            "${{ env.BACKEND_URL }}" \
            2>/dev/null)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Backend health check passed"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Backend health check failed with HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test leaderboard API
        id: leaderboard
        run: |
          echo "üîç Testing leaderboard API..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --max-time 30 \
            "${{ env.BACKEND_URL }}/api/leaderboard" \
            2>/dev/null)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Leaderboard API check passed"
            # Parse entry count
            ENTRIES=$(echo "$BODY" | jq 'length' 2>/dev/null || echo "unknown")
            echo "Leaderboard entries: $ENTRIES"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "‚ö†Ô∏è Database not configured on backend"
            echo "status=no_db" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Leaderboard API check failed with HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

  validate-database:
    name: Validate Supabase Database
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Test Supabase connection
        id: supabase
        run: |
          echo "üîç Testing Supabase REST API..."
          
          # Get the API key from config.js
          API_KEY=$(node -e "console.log(require('./js/config.js').SUPABASE_ANON_KEY)")
          
          if [ -z "$API_KEY" ] || [ "$API_KEY" = "undefined" ]; then
            echo "‚ùå Supabase API key not configured"
            exit 1
          fi
          
          echo "API Key configured: ${API_KEY:0:10}..."
          
          # Test the REST API
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --max-time 30 \
            -H "apikey: $API_KEY" \
            -H "Authorization: Bearer $API_KEY" \
            "${{ env.SUPABASE_URL }}/rest/v1/players?limit=1" \
            2>/dev/null)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Supabase connection successful"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "‚ùå Invalid API key"
            echo "status=auth_failed" >> $GITHUB_OUTPUT
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "‚ö†Ô∏è Table 'players' not found - migrations may need to be run"
            echo "status=no_table" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Supabase connection failed with HTTP $HTTP_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Check database tables
        id: tables
        run: |
          echo "üîç Checking database tables..."
          
          API_KEY=$(node -e "console.log(require('./js/config.js').SUPABASE_ANON_KEY)")
          TABLES="players player_stats matches"
          ALL_OK=true
          
          for TABLE in $TABLES; do
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              --max-time 15 \
              -H "apikey: $API_KEY" \
              -H "Authorization: Bearer $API_KEY" \
              "${{ env.SUPABASE_URL }}/rest/v1/${TABLE}?limit=1" \
              2>/dev/null)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Table '$TABLE' exists"
            else
              echo "‚ùå Table '$TABLE' not found (HTTP $HTTP_CODE)"
              ALL_OK=false
            fi
          done
          
          if [ "$ALL_OK" = "true" ]; then
            echo "‚úÖ All database tables present"
          else
            echo "‚ö†Ô∏è Some tables are missing - run database migrations"
            echo "Run: supabase db push"
            echo "Or apply SQL from: supabase/migrations/"
          fi

  connection-summary:
    name: Connection Summary
    runs-on: ubuntu-latest
    needs: [validate-backend, validate-database]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "============================================"
          echo "üéÆ Pong7 Connection Validation Summary"
          echo "============================================"
          echo ""
          echo "Backend Server:  ${{ needs.validate-backend.result }}"
          echo "Database:        ${{ needs.validate-database.result }}"
          echo ""
          
          if [ "${{ needs.validate-backend.result }}" = "success" ] && \
             [ "${{ needs.validate-database.result }}" = "success" ]; then
            echo "‚úÖ All connections validated successfully!"
          else
            echo "‚ö†Ô∏è Some connections need attention"
            echo ""
            echo "Troubleshooting:"
            echo "- Backend issues: Check https://dashboard.render.com"
            echo "- Database issues: Check https://supabase.com/dashboard"
            echo "- Run migrations: supabase db push"
          fi
